# tangæ°é¢è¯•é¢˜

## ä¸ºä»€ä¹ˆç‰›é¡¿æ³•ä¸èƒ½ä½œä¸ºä¼˜åŒ–å™¨ç®—æ³•

ç›¸å…³é“¾æ¥ï¼š[ç‰›é¡¿æ³•æœ€ä¼˜åŒ–ä»‹ç»](https://zh.d2l.ai/chapter_optimization/gd.html#id7)

>1.ç‰›é¡¿æ³•å¯¹äºæ¯ä¸ªå˜é‡éœ€è¦ä¿å­˜ä¸€ä¸ªhessiançŸ©é˜µï¼Œå³f(x)çš„äºŒé˜¶ä¿¡æ¯ï¼Œè¿™ä¸ªå­˜å‚¨é‡è¿‡å¤§(æ‰€ä»¥æ·±åº¦å­¦ä¹ æ¡†æ¶éƒ½æ˜¯åŸºäºä¸€é˜¶ä¿¡æ¯è¿›è¡Œä¼˜åŒ–)
>
>2.è§£æè§£åŒ…å«äº†å¯¹çŸ©é˜µçš„æ±‚é€†ï¼Œå¯èƒ½é‡åˆ°éå¥‡å¼‚çŸ©é˜µ



## ç®€è¿°adaç³»åˆ—ä¼˜åŒ–å™¨çš„ç‰¹ç‚¹ï¼Ÿå¦‚ä½•å®ç°çš„ï¼Ÿ

> adaç³»åˆ—ä¼˜åŒ–å™¨çš„ç‰¹ç‚¹ä¸ºï¼šæ ¹æ®å‚æ•°å†å²æ¢¯åº¦æ¥å†³å®šè¯¥è½®çš„æ›´æ–°é‡ï¼Œå…·æœ‰è‡ªé€‚åº”çš„ç‰¹ç‚¹ï¼Œå› æ­¤ä¸æ€ä¹ˆéœ€è¦è°ƒèŠ‚ä¼˜åŒ–å™¨ç›¸å…³å‚æ•°ã€‚
>
> æœ€æ—©çš„adagradç›´æ¥æŠŠæ‰€æœ‰çš„å†å²æ¢¯åº¦å¹³æ–¹å’Œè®°å½•è¿›æ¥ï¼Œå› æ­¤éšç€è®­ç»ƒè½®æ¬¡å¢åŠ ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´ä¸‹é™é€Ÿåº¦è¿‡æ…¢ç”šè‡³è¶‹äº0ã€‚
>
> å› æ­¤åç»­çš„adadeltaè€ƒè™‘æ·±åº¦å­¦ä¹ çš„ä»·å€¼å‡½æ•°çš„è®¾è®¡ï¼Œé€šè¿‡y_t=k*y_{t-1}+(1-k)\*gradçš„è®¾è®¡ä½¿å¾—è¿œç«¯çš„æ¢¯åº¦ä¼šè¢«å¿½ç•¥ï¼Œè§£å†³é€Ÿåº¦ä¸‹é™è¿‡å¿«çš„é—®é¢˜ã€‚
>
> Adamåˆ™æ˜¯å°†adaçš„æ€è·¯å’ŒåŠ¨é‡çš„æ€è·¯ç»“åˆèµ·æ¥ï¼Œé€šè¿‡adadeltaçš„å½¢å¼ï¼Œè®°å½•è¿‘æœŸæ¢¯åº¦å¹³æ–¹å’Œå’Œè¿‘æœŸæ¢¯åº¦å’Œ(åŠ¨é‡)ï¼Œé€šè¿‡ä¸€äº›ç®€å•å·¥ç¨‹ä¸Šçš„çŸ«æ­£ï¼Œå¾—åˆ°æœ€ç»ˆçš„æ›´æ–°å¼ã€‚

## torch.nn.softmaxå’Œtorch.nn.functional.softmaxæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿæ˜¯å¦ä¼šå¯¹è®¡ç®—å›¾äº§ç”Ÿå½±å“ï¼Ÿ

> å‰è€…æ˜¯classï¼Œåè€…æ˜¯functionï¼Œè°ƒç”¨æ–¹å¼ä¸ä¸€æ ·ï¼Œä½†æ˜¯éƒ½ä¼šå¯¹è®¡ç®—å›¾äº§ç”Ÿå½±å“ï¼Œå› ä¸ºä»–éƒ½è°ƒç”¨äº†ä¼šå½±å“è®¡ç®—å›¾çš„ç®—å­ã€‚

## ä¸Šä¸‹æ–‡çª—å£çš„é™åˆ¶çš„åº•å±‚åŸå› æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆè§£å†³æ–¹æ¡ˆå—ï¼Ÿ

> è‡ªæ³¨æ„åŠ›æœºåˆ¶éœ€è¦å¯¹åºåˆ—è¿›è¡Œå†…ç§¯ï¼Œæ—¶é—´ç©ºé—´å¤æ‚åº¦éƒ½æ˜¯O(n^2)ï¼Œè€ƒè™‘æ˜¾å­˜å¤§å°å’Œä¸Šä¸‹æ–‡çª—å£ï¼Œåºåˆ—é•¿åº¦ä¼šå—åˆ°é™åˆ¶ã€‚
>
> æœ€å¸¸è§„çš„å°±æ˜¯æ¥å…¥RAGï¼Œèƒ½å¤Ÿæ·»åŠ å¤–éƒ¨çŸ¥è¯†ï¼Œå¹¶ä¸”æ‰©å¤§æœ‰æ•ˆè¾“å…¥èŒƒå›´ã€‚
>
> è¿˜æœ‰ä¸€ä¸ªå«ç¨€ç–è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„ä¸œè¥¿ï¼Œè®©tokenåªå…³å¿ƒå‰åçš„ä¸€å®šèŒƒå›´çš„tokenï¼Œåœ¨ä¸€ä¸ªä¸ªå°èŒƒå›´è¿›è¡Œè‡ªæ³¨æ„åŠ›ï¼Œå°±èƒ½é™ä½å¤æ‚åº¦ã€‚

## è¯·å›ç­”ä¸‹å›¾å’Œæ³¨æ„åŠ›æœºåˆ¶æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œå“ªé‡Œä¸ä¸€æ ·äº†ï¼Ÿ

![a9ad57ee8a098832e7dccd77fd957bc](https://typorasyt.oss-cn-nanjing.aliyuncs.com/202410262136006.png)

> è¿™æ˜¯group ViTè®ºæ–‡ä¸­çš„group blockï¼Œç”¨äºåšè½¯èšç±»
>
> æœ€å¤§çš„å·®åˆ«æ˜¯ï¼Œæ³¨æ„åŠ›æœºåˆ¶æŠŠvalueåšäº†åŠ æƒå’Œï¼Œè¿™é‡Œæ˜¯ä¿ç•™äº†æ•´ä¸ªåŠ æƒçŸ©é˜µï¼Œå¯ä»¥çœ‹ä½œå‘å¤šä¸ªèšç±»ä¸­å¿ƒèšç±»çš„ç»“æœã€‚åªéœ€è°ƒèŠ‚gumble softmaxçš„æ¸©åº¦ï¼Œä½¿å¾—ç³»æ•°é€¼è¿‘ 0/1 ï¼Œé‚£ä¹ˆæœ€ç»ˆç»“æœå°±æ˜¯è‰¯å¥½çš„è½¯èšç±»ï¼Œè¿˜ç»´æŒäº†å¯å¯¼çš„æ€§è´¨

## batchnorm å’Œ layernorm çš„ä½œç”¨å’ŒåŒºåˆ«

ä¸ºä»€ä¹ˆè¦åšæ•°æ®å½’ä¸€åŒ–ï¼Ÿ

>ä¿è¯æ‰€æœ‰ç‰¹å¾åœ¨åŒä¸€åˆ»åº¦ä¸‹è¿›è¡Œä¼ é€’å’Œæ¯”è¾ƒ
>
>å¦‚æœä¸åšå½’ä¸€åŒ–ï¼Œæ•°å€¼è¾ƒå¤§çš„ç‰¹å¾ä¼šåœ¨ç­‰weightä¸‹ä¼šè®¡ç®—å‡ºæ›´å¤§çš„ç»“æœï¼Œ**æ·¹æ²¡**å…¶å®ƒç‰¹å¾å¸¦æ¥çš„å½±å“ã€‚
>
>åœ¨éšæœºæ¢¯åº¦ä¸‹é™çš„æ—¶å€™ï¼Œå‡è®¾y=aw+bw+cw, å¦‚æœaç‰¹åˆ«å¤§ï¼Œä¼šå¯¼è‡´æ¢¯åº¦åŸºæœ¬ä¸Šç”±**a**å†³å®šï¼Œå¯¼è‡´åœ¨**å…¶å®ƒæ–¹å‘**ä¸Šçš„ä¼˜åŒ–ææ…¢ã€‚(å¦‚å›¾ï¼Œåƒåªæœ‰ä¸€è¾¹åŠå…¶é™¡å³­çš„å³¡è°·)

![image-20241119004531218](https://typorasyt.oss-cn-nanjing.aliyuncs.com/202411190045271.png)

batch normåœ¨å¹²ä¸€ä»¶ä»€ä¹ˆäº‹

>batch norm åœ¨æŠŠä¸€ä¸ªbatchçš„æ•°æ®å½’ä¸€åŒ–(å‡å€¼å’Œæ–¹å·®ç”±batchçš„å€¼æ±‚å‡ºå¹¶è¿›è¡ŒåŠ¨é‡å¼æ›´æ–°ï¼Œå¹¶éäººä¸ºè§„å®š)ï¼Œå†é€šè¿‡å¯ä»¥å­¦ä¹ çš„è¶…å‚æ•°è¿›è¡Œæ”¾ç¼©ç§»åŠ¨åˆ°ä»»æ„å‡å€¼ã€æ–¹å·®çš„åˆ†å¸ƒ

![image-20241119005111755](https://typorasyt.oss-cn-nanjing.aliyuncs.com/202411190051954.png)

> batchnormå’Œlayernormåšçš„ä¸œè¥¿ç›¸ä¼¼ï¼Œbatch normæ˜¯ä¸€ä¸ªç‰¹å¾ä¸€ä¸ªç‰¹å¾å½’ä¸€åŒ–ï¼Œlayernormæ˜¯å¯¹ä¸€ä¸ªæ ·æœ¬ä¸€ä¸ªæ ·æœ¬å½’ä¸€åŒ–ï¼Œæ ¸å¿ƒåŸå› æ˜¯åœ¨nlpé¢†åŸŸï¼Œæ ·æœ¬ç»å¸¸æ˜¯ä¸ªsequenceï¼Œé•¿åº¦ä¸å®šï¼Œæ­¤æ—¶å¯¹batchåšnormalizationä¼šå¯¼è‡´å¾ˆå¤šæ¯”è¾ƒåé¢çš„tokenè·Ÿä¸€å †0ä¸€èµ·ç®—ï¼Œæ˜¾ç„¶ä¼šå‡ºé—®é¢˜ï¼Œäºæ˜¯é‡‡ç”¨layernormï¼Œå¯¹æ¯ä¸ªæ ·æœ¬è¿›è¡Œå½’ä¸€åŒ–ã€‚

## ä¸ºä»€ä¹ˆnumpy æ¯” listå¿«

> list æ…¢æ˜¯æ˜¾ç„¶çš„ï¼Œä»–ä¸æ˜¯è¿ç»­å†…å­˜ä¸”å­˜çš„ä¸œè¥¿ä¸å›ºå®šç±»å‹ï¼Œæ‰¹é‡å¤„ç†è‚¯å®šæ…¢
>
> numpyæœ‰å‡ ä¸ªä¼˜åŠ¿ï¼š
>
> â€‹	1.åº•å±‚å®ç°ä¸ºCç­‰æ›´æœºå™¨çº§åˆ«çš„è¯­è¨€ï¼Œæœ¬èº«ç¼–è¯‘é€Ÿåº¦å¿«
>
> â€‹	2.ä¸ºåŒç±»å‹é›†ä¸­å­˜å‚¨ï¼Œé€‚åˆä¸€å¨ä¸€æ¬¡æ€§æ¬è¿›**ç¼“å­˜**ï¼ŒåŠ å¿«è®¿é—®é€Ÿåº¦
>
> â€‹    3.å‘é‡åŒ–æ“ä½œï¼šå¯¹äºå‘é‡çš„è®¡ç®—æœ‰ç€è‰¯å¥½çš„å¯**å¹¶è¡Œ**ç‰¹æ€§ï¼Œnumpyå®ç°ä¸Šåšäº†å¹¶è¡ŒåŒ–ï¼Œå……åˆ†åˆ©ç”¨CPUèµ„æº

## ä¸ºä»€ä¹ˆå¸‚é¢ä¸Šçš„LLM ä¸»æµä¸ºdecoder-onlyï¼Œè€Œä¸æ˜¯encoder-only æˆ–è€… encoder-decoder?

![image-20250610220853929](https://typorasyt.oss-cn-nanjing.aliyuncs.com/202506102209020.png)

- decoder-onlyçš„ä¸‰è§’çŸ©é˜µå¿…å®šæ»¡ç§©

  > è§‚ç‚¹æ¬è¿è‡ªè‹ç¥(è‹å‰‘æ—)
  >
  > åŸæ–‡
  >
  > â€œä¼—æ‰€å‘¨çŸ¥ï¼ŒAttentionçŸ©é˜µä¸€èˆ¬æ˜¯ç”±ä¸€ä¸ªä½ç§©åˆ†è§£çš„çŸ©é˜µåŠ softmaxè€Œæ¥ï¼Œå…·ä½“æ¥è¯´æ˜¯ä¸€ä¸ª$ğ‘›Ã—ğ‘‘$çš„çŸ©é˜µä¸$ğ‘‘Ã—ğ‘›$çš„çŸ©é˜µç›¸ä¹˜åå†åŠ softmaxï¼ˆ$nâ‰«d$ï¼‰ï¼Œè¿™ç§å½¢å¼çš„Attentionçš„çŸ©é˜µå› ä¸ºä½ç§©é—®é¢˜è€Œå¸¦æ¥è¡¨è¾¾èƒ½åŠ›çš„ä¸‹é™ï¼Œå…·ä½“åˆ†æå¯ä»¥å‚è€ƒ[ã€ŠAttention is Not All You Need: Pure Attention Loses Rank Doubly Exponentially with Depthã€‹](https://papers.cool/arxiv/2103.03404)ã€‚è€ŒDecoder-onlyæ¶æ„çš„AttentionçŸ©é˜µæ˜¯ä¸€ä¸ªä¸‹ä¸‰è§’é˜µï¼Œæ³¨æ„ä¸‰è§’é˜µçš„è¡Œåˆ—å¼ç­‰äºå®ƒå¯¹è§’çº¿å…ƒç´ ä¹‹ç§¯ï¼Œç”±äºsoftmaxçš„å­˜åœ¨ï¼Œ**å¯¹è§’çº¿å¿…ç„¶éƒ½æ˜¯æ­£æ•°**ï¼Œæ‰€ä»¥å®ƒçš„è¡Œåˆ—å¼å¿…ç„¶æ˜¯æ­£æ•°ï¼Œå³Decoder-onlyæ¶æ„çš„**AttentionçŸ©é˜µä¸€å®šæ˜¯æ»¡ç§©**çš„ï¼æ»¡ç§©æ„å‘³ç€ç†è®ºä¸Šæœ‰æ›´å¼ºçš„è¡¨è¾¾èƒ½åŠ›ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒDecoder-onlyæ¶æ„çš„AttentionçŸ©é˜µåœ¨ç†è®ºä¸Šå…·æœ‰æ›´å¼ºçš„è¡¨è¾¾èƒ½åŠ›ï¼Œæ”¹ä¸ºåŒå‘æ³¨æ„åŠ›åè€Œä¼šå˜å¾—ä¸è¶³ã€‚â€
  >
  > å…¶å®æ„æ€å°±æ˜¯åŒå‘æ³¨æ„åŠ›å¯èƒ½é¢ä¸´è®­ç»ƒè¿‡åçŸ©é˜µrankåå¡Œçš„é—®é¢˜å¯¼è‡´ç­‰å‚æ•°ä¸‹ï¼Œæ¨¡å‹çš„å­¦ä¹ èƒ½åŠ›æ›´å·®çš„é—®é¢˜

- decoder ä»»åŠ¡å¤©ç”Ÿéš¾äºencoder ä»»åŠ¡ï¼Œå› æ­¤å¯èƒ½å­¦åˆ°æ›´å¥½çš„è¡¨ç¤º

> Ilya æ¼”è®²ä¸­ä¼¼ä¹æè¿‡è¿™ä¸€ç‚¹


## æ¯”è¾ƒ pretraining, CPTï¼ˆcontinual pre-trainingï¼‰,SFT,post training 

> æˆ‘ä»¬ä»è®­ç»ƒæ•°æ®ã€è®­ç»ƒæ–¹å¼(æŸå¤±å‡½æ•°)ã€è®­ç»ƒç›®æ ‡ä¸‰ä¸ªè§’åº¦æ¥é˜è¿°è¿™ä¸ªé—®é¢˜ã€‚
>
> pre-trainning ä½¿ç”¨è‡ªå›å½’çš„è®­ç»ƒæ–¹å¼ï¼Œæ•°æ®å¯ä»¥æ˜¯çˆ¬ä¸‹æ¥çš„ä»»ä½•æ–‡æœ¬ï¼Œæœ¬è´¨ä¸Šæ˜¯æ•™æ¨¡å‹åŸºç¡€çš„è¯­è¨€é€»è¾‘å’Œé€šç”¨çŸ¥è¯†ã€‚
>
> CPTä¹Ÿå«pre-training æ‰€ä»¥è®­ç»ƒæ–¹å¼æœ¬è´¨ä¸Šè¿˜æ˜¯pre-trainningï¼Œç›®çš„æ˜¯è®©æ¨¡å‹å­¦ä¼šæ–°çŸ¥è¯†æˆ–è€…æ˜¯ä¸€äº›é¢†åŸŸçŸ¥è¯†ï¼Œä¸ºé˜²æ­¢æ¨¡å‹é—å¿˜é€šç”¨çŸ¥è¯†ï¼Œä¸€èˆ¬æŠŠæ–°æ•°æ®å’Œæ™®é€šæ–‡æœ¬æ··åˆèµ·æ¥è®­ç»ƒæ¨¡å‹ã€‚
>
> SFT(supervised fine-tuning)åˆ™æ˜¯è®©æ¨¡å‹**å­¦ä¼šå¯¹è¯**(æˆ–è€…ç±»o1è¾“å‡ºä¹‹ç±»çš„è¦æ±‚)ï¼Œä¸€èˆ¬ç”¨ChatTemplateå»æ„é€ æ•°æ®ï¼Œä¸€èˆ¬è¿˜æ˜¯è‡ªå›å½’çš„è®­ç»ƒæ–¹å¼ã€‚
>
> post-training ä¸€èˆ¬ä¸ºRLHFç­‰åŸºäº**å¼ºåŒ–å­¦ä¹ **çš„å¯¹é½èŒƒå¼ï¼ŒåŒ…æ‹¬PPOï¼ŒDPOç­‰å¾®è°ƒï¼Œç›®çš„æ˜¯å¯¹æ¨¡å‹çš„å›å¤å¼•å…¥äººçš„åå¥½å’Œå®‰å…¨æ€§å¯¹é½ç­‰ã€‚ä¸€èˆ¬è®¤ä¸ºpost-trainingå¯¹æ¨¡å‹çš„**ä¿®æ”¹é‡æ¯”è¾ƒå°**ã€‚
>
> å…¶å®åé¢ä¸¤ç§æœ¬è´¨ä¸Šéƒ½æ˜¯å¾®è°ƒï¼Œä½†æ˜¯å¯ä»¥è®¤ä¸ºsftå¯¹æ¨¡å‹çš„ä¿®æ”¹å¤§äºpost-trainingï¼Œå› æ­¤éœ€è¦æ³¨æ„SFTçš„æ•°æ®è´¨é‡é—®é¢˜ã€‚

## ä»æ·±åº¦å­¦ä¹ çš„è§†è§’å¯¹ææ²çš„å‚æ•°æœåŠ¡å™¨å†…å®¹è¿›è¡Œæ¦‚è¿°ï¼Œæ„å»ºä¸€ä¸ªåŸºç¡€çš„æ·±åº¦å­¦ä¹ å¹¶è¡Œæ¡†æ¶

### æ‰€éœ€è¦è§£å†³çš„é—®é¢˜

1.èƒ½åœ¨è€ƒè™‘æ€§èƒ½çš„å‰æä¸‹ï¼ŒæŠŠåˆ†å¸ƒå¼æ¡†æ¶ç”¨äºæ·±åº¦å­¦ä¹ pipeline

2.æ„å»ºå…·æœ‰ä¸€å®šå¯æ‰©å±•æ€§å’Œå®¹ç¾èƒ½åŠ›çš„åˆ†å¸ƒå¼æ¡†æ¶

### æ¡†æ¶

![image-20250109142456254](https://typorasyt.oss-cn-nanjing.aliyuncs.com/202501091425387.png)

#### å¯æ‰©å±•æ€§

ä¸ºäº†å¯æ‰©å±•æ€§ï¼Œææ²æå‡ºçš„æ¡†æ¶ä»¥parameter serverä¸ºæ ¸å¿ƒï¼Œå­˜æƒé‡ï¼Œè´Ÿè´£æ•°æ®ç®¡ç†ã€‚è€Œworkeråªæ˜¯ä¸ªæ‰“å·¥çš„ï¼Œè´Ÿè´£è®¡ç®—æˆ–æŸç§ä»»åŠ¡ã€‚ç”±äº**workerå®Œå…¨ä¸å­˜å‚¨å‰¥ç¦»**ï¼Œå¯æ‰©å±•æ€§æ‹‰æ»¡äº†ã€‚

(æ•°æ®çš„åˆ†å‘å¯ä»¥é¢å¤–åšä¸€ä¸ªåˆ†å‘æ•°æ®çš„ç®¡ç†å™¨ï¼Œä¹Ÿå¯ä»¥è®©å‚æ•°æœåŠ¡å™¨ä»£åŠ³ï¼Œæ„Ÿè§‰ä¸æ˜¯å¾ˆé‡è¦ï¼Œå› ä¸ºæ²¡æœ‰åŒæ­¥éœ€æ±‚å’‹æ»´éƒ½è¡Œ)

#### å®¹ç¾æ–¹é¢

ä¸ºå‡å°é€šä¿¡æˆæœ¬ï¼Œworkerå‘å‚æ•°æœåŠ¡å™¨ç”³è¯·æ¨¡å‹æƒé‡ç­‰æ•°æ®çš„æ—¶å€™ï¼Œé€šè¿‡indexæ¥ç”³è¯·ã€‚

æ„å³ï¼Œäº‹å…ˆç»™weightåšä¸ª**hash mapping**ï¼Œkeyç”¨ä¸€å®šèŒƒå›´çš„intæ¥è¡¨ç¤ºï¼Œç›¸å½“äºç»™äº†weightä¸€äº›ä¸‹æ ‡ã€‚ç”¨è¿™äº›indexæ¥å¯¹weightè¿›è¡ŒæŒ‡ä»£ï¼Œåœ¨ä¸åˆ©ç”¨å…·ä½“å€¼çš„æ—¶å€™é€šè¿‡å¯¹indexçš„é€šè®¯æ¥ä¼ é€’ä¿¡æ¯ã€‚

è€Œå¯¹æƒé‡çš„å®¹ç¾å°±æ˜¯**ç»´æŠ¤è¿™ä¸ªdict**ã€‚

![image-20250109144530040](https://typorasyt.oss-cn-nanjing.aliyuncs.com/202501091445096.png)

å…·ä½“æ¥è¯´ï¼Œæ ¹æ®å‚æ•°æœåŠ¡å™¨çš„æœåŠ¡å™¨æ•°é‡ï¼Œæ ¹æ®keyçš„èŒƒå›´å„è‡ªç»´æŠ¤ä¸€æ®µdictï¼Œè€Œæ¯ä¸ªæœåŠ¡å™¨åˆæ ¹æ®keyçš„èŒƒå›´é¡ºå¸¦å¤‡ä»½åé¢ä¸¤æ®µçš„dictï¼Œç›¸å½“äº**å¾ªç¯å¤‡ä»½äº†ä¸¤ä»½**ï¼Œå¹¶ä¸”è¿™äº›æœåŠ¡å™¨æœ¬èº«å°±å‚ä¸æ¶æ„ï¼Œå¯ä»¥ç¬é—´å¯åŠ¨ã€‚

### é€šä¿¡æˆæœ¬é—®é¢˜

è¿™å¥—æ¶æ„æœ€å¤§çš„é—®é¢˜å°±æ˜¯é€šè®¯æˆæœ¬æé«˜ï¼Œå¦‚æœä¸åšè°ƒæ•´ï¼Œpullå’Œpushéƒ½å¾—ä¼ ä¸€éæ•´ä¸ªæƒé‡/æ•´ä¸ªæ¢¯åº¦ï¼Œç›¸å½“ç‚¸è£‚ã€‚

ä¸ºæ­¤ï¼Œææ²åœ¨é€šè®¯å‰åå¯¹æ•°æ®è¿›è¡Œå‹ç¼©ï¼Œä¸€èˆ¬æƒé‡çš„å‹ç¼©æ•ˆæœæ¯”è¾ƒå¥½ï¼Œkeyå°±ä¸å¤ªèƒ½å‹ç¼©ã€‚

ä½†æ˜¯å…¶å®è¿˜æ˜¯æ”¹å˜ä¸äº†é€šè®¯æˆæœ¬å¤ªç‚¸è£‚çš„é—®é¢˜ã€‚

### waiting timeé—®é¢˜

ç”±äºä¸åŒworkeræ‰§è¡Œå®Œä»»åŠ¡çš„æ—¶é—´æ˜¯ä¸ä¸€è‡´çš„ï¼Œä¸ºäº†å‡å°‘workeré—´çš„ç›¸äº’ç­‰å¾…ï¼Œå®æ“ä¸Šæˆ‘ä»¬é€‰æ‹©**ç‰ºç‰²æ”¶æ•›é€Ÿåº¦**ï¼Œä¸å³æ—¶æ›´æ–°æƒé‡(æœ‰é™åº¦**å»¶è¿Ÿæ›´æ–°**æˆ–è€…å®Œå…¨å»¶è¿Ÿæ›´æ–°)

![image-20250109145702160](https://typorasyt.oss-cn-nanjing.aliyuncs.com/202501091457207.png)

## è¯·ä»‹ç»Megatron

> Megatron æ˜¯é’ˆå¯¹**å¤§è¯­è¨€æ¨¡å‹**çš„åŸºäºpytorchçš„**åˆ†å¸ƒå¼**è®­ç»ƒæ¡†æ¶ã€‚
>
> ä¸ºè§£å†³æ¨¡å‹å‚æ•°è¿‡å¤šçš„é—®é¢˜ï¼Œè®¾è®¡äº†**ä¸‰å±‚å¹¶è¡Œ**ã€‚
>
> æ³¨æ„ï¼Œæˆ‘ä»¬çœ‹å¹¶è¡Œæ¨¡å‹è¦æ³¨é‡çœ‹ä¸åŒé€šä¿¡æ¨¡å¼ä¸‹çš„é€šä¿¡é‡ã€‚
>
> - **æ•°æ®å¹¶è¡Œ (DP)**: æ•°æ®å¹¶è¡Œæ¨¡å¼ä¼šåœ¨æ¯ä¸ªworkerä¹‹ä¸Š**å¤åˆ¶ä¸€ä»½æ¨¡å‹**ï¼Œè¿™æ ·æ¯ä¸ªworkeréƒ½æœ‰ä¸€ä¸ªå®Œæ•´æ¨¡å‹çš„å‰¯æœ¬ã€‚è¾“å…¥æ•°æ®é›†æ˜¯åˆ†ç‰‡çš„ï¼Œä¸€ä¸ªè®­ç»ƒçš„å°æ‰¹é‡æ•°æ®å°†åœ¨å¤šä¸ªworkerä¹‹é—´åˆ†å‰²ï¼›worker**å®šæœŸæ±‡æ€»**å®ƒä»¬çš„æ¢¯åº¦ï¼Œä»¥ç¡®ä¿æ‰€æœ‰workerçœ‹åˆ°ä¸€ä¸ªä¸€è‡´çš„æƒé‡ç‰ˆæœ¬
> - **å¼ é‡å¹¶è¡Œ (TP)**: çŸ©é˜µå¤ªå¤§ï¼Œæ˜¾å­˜å¤ªå°æ”¾ä¸ä¸‹ï¼Œåªèƒ½æŠŠ**çŸ©é˜µè¿ç®—åˆ†é…åˆ°ä¸åŒçš„è®¾å¤‡ä¹‹ä¸Š**ï¼Œæ¯”å¦‚æŠŠæŸä¸ªçŸ©é˜µä¹˜æ³•åˆ‡åˆ†æˆä¸ºå¤šä¸ªçŸ©é˜µä¹˜æ³•æ”¾åˆ°ä¸åŒè®¾å¤‡ä¹‹ä¸Š(å¯¹åº”çš„batchçš„çŸ©é˜µä¹Ÿä¼šè¢«æ‹†åˆ†)ã€‚
> - **æµæ°´çº¿å¹¶è¡Œ (PP)**: æŠŠæ¨¡å‹**ä¸åŒçš„å±‚æ”¾åˆ°ä¸åŒè®¾å¤‡ä¹‹ä¸Š**ï¼Œæ¯”å¦‚å‰é¢å‡ å±‚æ”¾åˆ°ä¸€ä¸ªè®¾å¤‡ä¹‹ä¸Šï¼Œä¸­é—´å‡ å±‚æ”¾åˆ°å¦å¤–ä¸€ä¸ªè®¾å¤‡ä¸Šï¼Œæœ€åå‡ å±‚æ”¾åˆ°ç¬¬ä¸‰ä¸ªè®¾å¤‡ä¹‹ä¸Šã€‚ï¼ˆè¿™æ ·æŠŠpipelineè¿›è¡Œæ‹†åˆ†ç»†åŒ–èƒ½å¤Ÿå‡å°backwardå’Œforwardçš„ä¾èµ–æ€§å¸¦æ¥çš„waiting timeï¼‰
>
> 

![image-20241224202714231](https://typorasyt.oss-cn-nanjing.aliyuncs.com/202412242027330.png)

![image-20241224202736900](https://typorasyt.oss-cn-nanjing.aliyuncs.com/202412242027981.png)

## è¯·ç»™å‡ºä»¥ä¸‹ä»£ç çš„è¾“å‡º

```python
def get_iter(id):
    if id==1:
        yield from range(2)
    elif id==2:
        yield from range(3,5)
    else:
        return iter(range(10))
for i in range(3):
    for j in get_iter(i):
        print(j)

```

> å…³é”®æ³¨æ„è¿™ä¸ªç•œç”Ÿ returnï¼Œ åœ¨å‡½æ•°é‡Œé¢æœ‰yeildçš„æƒ…å†µä¸‹ï¼Œreturnç­‰ä»·äºStopIteration,è¾“å‡ºå¦‚ä¸‹

>0
>1
>3
>4

## ä»‹ç»deepspeedçš„ZeRO

> ä¸ºäº†å‡å°‘è®­ç»ƒé˜¶æ®µçš„æ˜¾å­˜æ¶ˆè€—ï¼Œdeepspeedæ¡†æ¶æä¾›äº†ZeRO(Zero Redundancy Optimizer)æ–¹æ³•ã€‚
>
> å›å¿†DPå‚æ•°æœåŠ¡å™¨ï¼Œæ¯ä¸ªworkeréƒ½å¾—è·‘æ•´ä¸ªæ¨¡å‹ï¼Œå­˜å‚¨å¯¹åº”çš„å‚æ•°å’Œï¼Œä¼˜åŒ–å™¨å‚æ•°ç­‰ã€‚
>
> ä½†æ˜¯å®é™…ä¸Šéƒ½åªéœ€è¦ä¸€ä»½å°±è¡Œäº†ã€‚
>
> ZeROçš„æ€æƒ³å°±æ˜¯å»æŠŠè¿™äº›è¿›è¡Œèšåˆå’Œåˆ‡ç‰‡ï¼Œåˆ†åˆ°æ¯ä¸ªworkerä¸Šã€‚
>
> åˆ†ä¸‰ä¸ªstage

![image-20250120150954183](https://typorasyt.oss-cn-nanjing.aliyuncs.com/202501201510308.png)

> å¼€çš„çº¦é«˜è¶Šçœæ˜¾å­˜ï¼Œä½†æ˜¯ç”±äºè¿™äº›èµ„æºæ¯æ¬¡è°ƒç”¨éƒ½å¾—workerä¹‹é—´é€šè®¯ï¼Œ**é€šè®¯æˆæœ¬å¤§å¤§å¢åŠ **ã€‚
>
> å¯ä»¥ç†è§£ä¸ºï¼ŒæŠŠæ•´ä¸ªæ¨¡å‹æ‹†åˆ†æˆäº†è‹¥å¹²ä¸ªå±‚(ä¸æ¨¡å‹æ— å…³)ï¼Œæ¯æ¬¡å¼€å§‹è®¡ç®—è¿™ä¸ªå±‚çš„æ—¶å€™ï¼Œå·¦å³workerç»è¿‡é€šè®¯æ‹¿åˆ°æ‰€éœ€è¦çš„è¯¥å±‚ç›¸å…³çš„å‚æ•°ï¼Œç»“æŸååˆå¹¿æ’­æˆ–è€…æ±‚å’Œåå†å¹¿æ’­ï¼Œä½¿å¾—æ¯ä¸ªworkeråªå­˜å…¶ä¸­ä¸€éƒ¨åˆ†å‚æ•°ã€‚

> torchä¹Ÿå¯¹è¿™ä¸ªåšäº†é€‚é…ï¼Œå«åšfsdpï¼Œå®ç°ä¸Šæœ‰ä¸€å®šå·®åˆ«ï¼Œä½†æ˜¯æ•ˆæœéƒ½æ˜¯å‡å°‘æ˜¾å­˜æ¶ˆè€—ã€‚
>
> è°ƒç”¨æ–¹å¼ä¸Šï¼Œéƒ½å¯ä»¥é‡‡ç”¨accelerate config æ¥è¿›è¡Œé…ç½®åè°ƒç”¨ã€‚ä»£ç ä¸­åªéœ€é€‚é…accelerateå³å¯ã€‚
>
> å…·ä½“é€‚é…ä¸Šçš„ç»†èŠ‚å¯ä»¥è§ç½‘å€ï¼š[7_accelerate (huaxiaozhuan.com)](https://www.huaxiaozhuan.com/å·¥å…·/huggingface_transformer/chapters/7_accelerate.html)

## èƒ½è®²ä¸€ä¸‹ä¸Šå±‚pythonå†™ä¸€ä¸ªåŠ æ³•dispatchç®—å­åˆ°æ•´ä¸ªæµç¨‹å—



## è®²è®²æ€ä¹ˆåˆ¤æ–­ä¸¤ä¸ªtensoræŒ‡å‘åŒä¸€å—ç°å­˜



## autograd engine å¯¹äºåˆ†å¸ƒå¼çš„æƒ…å†µæ˜¯å¦‚ä½•å¤„ç†çš„